### U-boot烧写

因为目标板上并没有`U-boot`，所以要采用海思自带工具`HiTool`进行烧写,直接进行`Fastboot`烧写，将`U-boot`烧写进`flash`中。

目标板上的`flash`型号为`MX25U25635F`，`DDR`的型号`MT40A512M1JY-083E`.

通过海思文档`ReleaseDoc/zh/02.only for reference/Test Report`目录下的`《Hi3559A╱C V100 Compatibility Test Report (only for reference).xls》`描=描述，已有的`flash`和`DDR`型号是支持的，所以在`U-boot`中不需要进行`flash ID`的添加和`DDR`的配置修改。直接使用原有的`U-boot`即可。

烧写步骤如下：

- 在`Hi3559AV100R001C02SPC020/01.software/pc/HiTool`目录下解压后进入`HiTool`工具，选择`HiBurn`，选择串口进行烧写（此时的目标板上没有网口驱动，不能用网口烧写）
- 选择`Burn Fastboot`页签，将`Flash Type`选择为`Spi Nor`，将编译好的`U-boot`传入，点击烧写，给目标板断电重启进行烧写

烧写完成后从`minicom`进入`U-boot`，发现`U-boot`烧写成功，但是串口没有答应出相应信息（连最基本的system startup也没有打印），阅读文档`《基于Hifmcv100控制器的Flash移植指南.pdf》`发现相应问题，其中问题描述为`SPI Nor Flash 3byte/4byte 启动和 SPI Nand Flash 1/4 线启动`

问题描述见文档



然后在解决办法中发现可以烧写到DDR中，将U-boot烧写到DDR中后，通过源代码的阅读和修改重新编译U-boot，烧写进DDR中后进入U-boot控制台界面，将整个流程基本理顺。

烧写进入DDR中的flash可以正确启动，打印出相关信息。

然后将Flash中的文件通过以下命令拷贝到DDR中并进行读取（读取结果为二进制）

```shell
hisilicon # sf probe
hisilicon # nor info
Unknown command 'nor' - try 'help'
hisilicon # nand info

hisilicon # sf read 0x82000000 0x0 0x100
device 0 offset 0x0, size 0x100

SF: 256 bytes @ 0x0 Read: OK
hisilicon # md 0x82000000 0x100

82000000: 14000a1c deadbeef deadbeef deadbeef    ................
82000010: deadbeef deadbeef deadbeef deadbeef    ................
82000020: deadbeef deadbeef deadbeef deadbeef    ................
82000030: deadbeef deadbeef deadbeef deadbeef    ................
82000040: 12010034 00000001 00000000 0000b805    4...............
82000050: 12010034 00000000 00000000 0000b805    4...............
82000060: 12010110 00000001 00000000 00008805    ................
82000070: 120100e4 00000000 00000000 000000fd    ................
82000080: 120100e8 00000000 00000000 000000fd    ................
82000090: 00000000 00000000 00000064 00000000    ........d.......
820000a0: 12010000 12000000 00000000 000000fd    ................
820000b0: 12010004 01001043 00000000 000000fd    ....C...........
820000c0: 12010058 00000006 00000000 00000015    X...............
820000d0: 12010010 12800000 00000000 000000fd    ................
820000e0: 12010014 00001037 00000000 000000fd    ....7...........
820000f0: 12010058 0000008b 00000000 0000184d    X...........M...
82000100: 43427d7c 47464140 44457a7b 40414647    |}BC@AFG{zEDGFA@
82000110: 53524d4c 57565150 54554a4b 50515657    LMRSPQVWKJUTWVQP
82000120: 23225d5c 27262120 24255a5b 20212627    \]"# !&'[Z%$'&! 
82000130: 33322d2c 37363130 34352a2b 30313637    ,-230167+*547610
82000140: 03023d3c 07060100 04053a3b 00010607    <=......;:......
82000150: 13120d0c 17161110 14150a0b 10111617    ................
82000160: e3e21d1c e7e6e1e0 e4e51a1b e0e1e6e7    ................
82000170: f3f2edec f7f6f1f0 f4f5eaeb f0f1f6f7    ................
82000180: 70714e4f 74757273 77764948 73727574    ONqpsrutHIvwturs
82000190: 60617e7f 64656263 67667978 63626564    .~a`cbedxyfgdebc
820001a0: 10116e6f 14151213 17166968 13121514    on......hi......
820001b0: 00011e1f 04050203 07061918 03020504    ................
820001c0: 30310e0f 34353233 37360908 33323534    ..103254..674523
820001d0: 20213e3f 24252223 27263938 23222524    ?>! #"%$89&'$%"#
820001e0: d0d12e2f d4d5d2d3 d7d62928 d3d2d5d4    /.......()......
820001f0: c0c1dedf c4c5c2c3 c7c6d9d8 c3c2c5c4    ................
82000200: 8382bdbc 87868180 8485babb 80818687    ................
82000210: 93928d8c 97969190 94958a8b 90919697    ................
82000220: e3e29d9c e7e6e1e0 e4e59a9b e0e1e6e7    ................
82000230: f3f2edec f7f6f1f0 f4f5eaeb f0f1f6f7    ................
82000240: c3c2fdfc c7c6c1c0 c4c5fafb c0c1c6c7    ................
82000250: d3d2cdcc d7d6d1d0 d4d5cacb d0d1d6d7    ................
82000260: 2322dddc 27262120 2425dadb 20212627    .."# !&'..%$'&! 
82000270: 33322d2c 37363130 34352a2b 30313637    ,-230167+*547610
82000280: e0e1dedf e4e5e2e3 e7e6d9d8 e3e2e5e4    ................
82000290: f0f1eeef f4f5f2f3 f7f6e9e8 f3f2f5f4    ................
820002a0: 8081feff 84858283 8786f9f8 83828584    ................
820002b0: 90918e8f 94959293 97968988 93929594    ................
820002c0: a0a19e9f a4a5a2a3 a7a69998 a3a2a5a4    ................
820002d0: b0b1aeaf b4b5b2b3 b7b6a9a8 b3b2b5b4    ................
820002e0: 4041bebf 44454243 4746b9b8 43424544    ..A@CBED..FGDEBC
820002f0: 50514e4f 54555253 57564948 53525554    ONQPSRUTHIVWTURS
82000300: 8382bdbc 87868180 8485babb 80818687    ................
82000310: 93928d8c 97969190 94958a8b 90919697    ................
82000320: e3e29d9c e7e6e1e0 e4e59a9b e0e1e6e7    ................
82000330: f3f2edec f7f6f1f0 f4f5eaeb f0f1f6f7    ................
82000340: c3c2fdfc c7c6c1c0 c4c5fafb c0c1c6c7    ................
82000350: d3d2cdcc d7d6d1d0 d4d5cacb d0d1d6d7    ................
82000360: 2322dddc 27262120 2425dadb 20212627    .."# !&'..%$'&! 
82000370: 33322d2c 37363130 34352a2b 30313637    ,-230167+*547610
82000380: e0e1dedf e4e5e2e3 e7e6d9d8 e3e2e5e4    ................
82000390: f0f1eeef f4f5f2f3 f7f6e9e8 f3f2f5f4    ................
820003a0: 8081feff 84858283 8786f9f8 83828584    ................
820003b0: 90918e8f 94959293 97968988 93929594    ................
820003c0: a0a19e9f a4a5a2a3 a7a69998 a3a2a5a4    ................
820003d0: b0b1aeaf b4b5b2b3 b7b6a9a8 b3b2b5b4    ................
820003e0: 4041bebf 44454243 4746b9b8 43424544    ..A@CBED..FGDEBC
820003f0: 50514e4f 54555253 57564948 53525554    ONQPSRUTHIVWTURS
hisilicon # md 0x82000000 0x100
82000000: 14000a1c deadbeef deadbeef deadbeef    ................
82000010: deadbeef deadbeef deadbeef deadbeef    ................
82000020: deadbeef deadbeef deadbeef deadbeef    ................
82000030: deadbeef deadbeef deadbeef deadbeef    ................
82000040: 12010034 00000001 00000000 0000b805    4...............
82000050: 12010034 00000000 00000000 0000b805    4...............
82000060: 12010110 00000001 00000000 00008805    ................
82000070: 120100e4 00000000 00000000 000000fd    ................
82000080: 120100e8 00000000 00000000 000000fd    ................
82000090: 00000000 00000000 00000064 00000000    ........d.......
820000a0: 12010000 12000000 00000000 000000fd    ................
820000b0: 12010004 01001043 00000000 000000fd    ....C...........
820000c0: 12010058 00000006 00000000 00000015    X...............
820000d0: 12010010 12800000 00000000 000000fd    ................
820000e0: 12010014 00001037 00000000 000000fd    ....7...........
820000f0: 12010058 0000008b 00000000 0000184d    X...........M...
82000100: 43427d7c 47464140 44457a7b 40414647    |}BC@AFG{zEDGFA@
82000110: 53524d4c 57565150 54554a4b 50515657    LMRSPQVWKJUTWVQP
82000120: 23225d5c 27262120 24255a5b 20212627    \]"# !&'[Z%$'&! 
82000130: 33322d2c 37363130 34352a2b 30313637    ,-230167+*547610
82000140: 03023d3c 07060100 04053a3b 00010607    <=......;:......
82000150: 13120d0c 17161110 14150a0b 10111617    ................
82000160: e3e21d1c e7e6e1e0 e4e51a1b e0e1e6e7    ................
82000170: f3f2edec f7f6f1f0 f4f5eaeb f0f1f6f7    ................
82000180: 70714e4f 74757273 77764948 73727574    ONqpsrutHIvwturs
82000190: 60617e7f 64656263 67667978 63626564    .~a`cbedxyfgdebc
820001a0: 10116e6f 14151213 17166968 13121514    on......hi......
820001b0: 00011e1f 04050203 07061918 03020504    ................
820001c0: 30310e0f 34353233 37360908 33323534    ..103254..674523
820001d0: 20213e3f 24252223 27263938 23222524    ?>! #"%$89&'$%"#
820001e0: d0d12e2f d4d5d2d3 d7d62928 d3d2d5d4    /.......()......
820001f0: c0c1dedf c4c5c2c3 c7c6d9d8 c3c2c5c4    ................
82000200: 8382bdbc 87868180 8485babb 80818687    ................
82000210: 93928d8c 97969190 94958a8b 90919697    ................
82000220: e3e29d9c e7e6e1e0 e4e59a9b e0e1e6e7    ................
82000230: f3f2edec f7f6f1f0 f4f5eaeb f0f1f6f7    ................
82000240: c3c2fdfc c7c6c1c0 c4c5fafb c0c1c6c7    ................
82000250: d3d2cdcc d7d6d1d0 d4d5cacb d0d1d6d7    ................
82000260: 2322dddc 27262120 2425dadb 20212627    .."# !&'..%$'&! 
82000270: 33322d2c 37363130 34352a2b 30313637    ,-230167+*547610
82000280: e0e1dedf e4e5e2e3 e7e6d9d8 e3e2e5e4    ................
82000290: f0f1eeef f4f5f2f3 f7f6e9e8 f3f2f5f4    ................
820002a0: 8081feff 84858283 8786f9f8 83828584    ................
820002b0: 90918e8f 94959293 97968988 93929594    ................
820002c0: a0a19e9f a4a5a2a3 a7a69998 a3a2a5a4    ................
820002d0: b0b1aeaf b4b5b2b3 b7b6a9a8 b3b2b5b4    ................
820002e0: 4041bebf 44454243 4746b9b8 43424544    ..A@CBED..FGDEBC
820002f0: 50514e4f 54555253 57564948 53525554    ONQPSRUTHIVWTURS
82000300: 8382bdbc 87868180 8485babb 80818687    ................
82000310: 93928d8c 97969190 94958a8b 90919697    ................
82000320: e3e29d9c e7e6e1e0 e4e59a9b e0e1e6e7    ................
82000330: f3f2edec f7f6f1f0 f4f5eaeb f0f1f6f7    ................
82000340: c3c2fdfc c7c6c1c0 c4c5fafb c0c1c6c7    ................
82000350: d3d2cdcc d7d6d1d0 d4d5cacb d0d1d6d7    ................
82000360: 2322dddc 27262120 2425dadb 20212627    .."# !&'..%$'&! 
82000370: 33322d2c 37363130 34352a2b 30313637    ,-230167+*547610
82000380: e0e1dedf e4e5e2e3 e7e6d9d8 e3e2e5e4    ................
82000390: f0f1eeef f4f5f2f3 f7f6e9e8 f3f2f5f4    ................
820003a0: 8081feff 84858283 8786f9f8 83828584    ................
820003b0: 90918e8f 94959293 97968988 93929594    ................
820003c0: a0a19e9f a4a5a2a3 a7a69998 a3a2a5a4    ................
820003d0: b0b1aeaf b4b5b2b3 b7b6a9a8 b3b2b5b4    ................
820003e0: 4041bebf 44454243 4746b9b8 43424544    ..A@CBED..FGDEBC
820003f0: 50514e4f 54555253 57564948 53525554    ONQPSRUTHIVWTURS


```

然后通过UltraEdit去读取编译好的U-boot文件，对比两者发现并没有错位或者1位翻转的现象，说明将U-boot烧写进Flash这个过程并没有问题

然后通过一些命令将Flash中的指令拷贝到DDR中，并通过go命令进行执行

```shell
hisilicon # printenv
arch=arm
baudrate=115200
board=hi3559av100
board_name=hi3559av100
bootargs=mem=256M console=ttyAMA0,115200n8
bootcmd=bootm 0x42000000
bootdelay=2
cpu=armv8
ethact=gmac0
soc=hi3559av100
stderr=serial
stdin=serial
stdout=serial
vendor=hisilicon
verify=n

Environment size: 283/262140 bytes
hisilicon # sf read 0x42000000 0x0 0x60000
device 0 offset 0x0, size 0x60000

SF: 393216 bytes @ 0x0 Read: OK
hisilicon # bootm 0x42000000
Wrong Image Format for bootm command
ERROR: can't get kernel image!
hisilicon # go 0x42000000
## Starting application at 0x42000000 ...

System startup

Uncompress Ok!

U-Boot 2016.11 (Dec 04 2019 - 15:51:10 +0800)hi3559av100

Relocation Offset is: 176ed000
Relocating to 5feed000, new gd at 5fe4ce00, sp at 5fe4cdf0
SPI Nor:  Check Flash Memory Controller v100 ... Found
SPI Nor ID Table Version 1.0
SPI Nor(cs 0) ID: 0xc2 0x25 0x39
Block:64KB Chip:32MB Name:"MX25U25635F/45G"
SPI Nor total size: 32MB
NAND:  0 MiB
MMC:   
*** Warning - bad CRC, using default environment

In:    serial
Out:   serial
Err:   serial
Net:   gmac0
Error: gmac0 address not set.
, gmac1
Error: gmac1 address not set.

Hit any key to stop autoboot:  0 
Wrong Image Format for bootm command
ERROR: can't get kernel image!
hisilicon # 
```

发现成功地打印出相关启动信息，说明烧写进入Flash的U-boot能够正确启动，将问题定位到海思芯片上的bootrom不能正确引导Uboot，所以不能启动。结合文档上说明的3byte/4byte，阅读MX25U25635F的文档，发现默认设置为3byte模式，目标板上接线模式为4线，两者存在冲突，将目标班上的接线模式改为3线之后能够正确启动U-boot。





### FAQ

现在的模式为3byte，这只能满足器件大小在16M之下的情况下，那么大于16M的情况呢？因为目标板上的器件大小为32M。如何通过命令将其设置为4byte模式。



不能确定是烧写时是4byte烧写，读取为3byte，还是烧写时为3byte，读取为4byte造成的错误？还需要进一步探索。





