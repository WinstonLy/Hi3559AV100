### 一 U-boot烧写

海思U-boot调试过程中发现一直烧写不了，后发现海思一直处于复位状态，检查发现原理图`R68 1Kohm`下拉电阻不应该焊接，拆掉电阻后复位状态恢复正常；

#### 1. 烧写

因为目标板上并没有`U-boot`，所以要采用海思自带工具`HiTool`进行烧写,直接进行`Fastboot`烧写，将`U-boot`烧写进`flash`中。

目标板上的`flash`型号为`MX25U25635F`，`DDR`的型号`MT40A512M1JY-083E`.

通过海思文档`ReleaseDoc/zh/02.only for reference/Test Report`目录下的`《Hi3559A╱C V100 Compatibility Test Report (only for reference).xls》`描=描述，已有的`flash`和`DDR`型号是支持的，所以在`U-boot`中不需要进行`flash ID`的添加和`DDR`的配置修改。直接使用原有的`U-boot`即可。

- `HiTool`烧写步骤如下：

  1. 在`Hi3559AV100R001C02SPC020/01.software/pc/HiTool`目录下解压后进入`HiTool`工具，选择`HiBurn`，选择串口进行烧写（此时的目标板上没有网口驱动，不能用网口烧写）

  2. 选择`Burn Fastboot`页签，将`Flash Type`选择为`Spi Nor`，将编译好的`U-boot`传入，点击烧写，给目标板断电重启进行烧写

- `tftp`烧写指令如下：

  ```shell
  mw.b 0x41000000 0xff 0x100000 				/* 对内存初始化*/ 
  tftp 0x41000000 u-boot-hi3559av100.bin 		/*U-boot下载到内存*/ 
	sf probe 0 									/*探测并初始化SPI flash*/ 
  sf erase 0x0 0x100000 						/*擦除 1M大小*/ 
  sf write 0x41000000 0x0 0x100000 			/*从内存写入SPI NOR Flash,0x0表示偏移地址*/ 
  ```
  
  

#### 2. 烧写成功但串口无打印信息

烧写完成后从`minicom`进入`U-boot`，发现`U-boot`烧写成功，但是串口没有打印出相应信息（连最基本的system startup也没有打印），阅读文档`《基于Hifmcv100控制器的Flash移植指南.pdf》`发现相应问题，其中问题描述为：

```shell
`Hiburn 显示烧写成功，但串口没打印`
3Byte/4Byte地址位宽这个概念是针对于 SPI Nor 的。芯片在上电启动的时候，会去读取SPI Nor Flash 的前1MB空间，单板上的3Byte/4Byte决定了控制器读取时下发的地址宽度。
- 3Byte地址位宽最大的寻址空间是16MB，所以对于容量不大于16MB的SPI Nor Flash的 3Byte/4Byte模式拨码必须是   3Byte；
- 对于大部分 32MB 及其更大容量的 SPI Nor Flash，出厂时器件默认是 3Byte 模式，意味着只能访问前 16MB 空     间，所以此时 3Byte/4Byte 模式拨码必须是3Byte；
- 对于一小部分 32MB 及其更大容量的 SPI Nor Flash，比如 MXIC MX25L25735E 和Winbond W25Q257FV，出厂时   器件默认是 4Byte 模式，这类器件 3Byte/4Byte 模式拨码必须是 4Byte。
```

确认`3byte/4byte`的方式如下：

>`Fastboot `先选择烧写` DDR`，启动之后读写数据，如果发现读出来的数据跟原始数据对比发现数据发现错位，基本上可以确认是`3Byte/4Byte `接口问题。还 一种厂家是掉电能启动，发复位命令发现 `Flash` 启动不了，一般也是这个问题。
>
>**问题处理方法**
>
>检查一下单板拨码，或者要检查一下软件复位流程是否成功

在解决办法中发现可以将`U-boot`烧写到`DDR`中，先修改相应的程序，打印输出相应的信息，从而梳理程序的流程。发	现在`DDR`中的`U-boot`可以正常启动。

在`DDR`中启动`U-boot`打印信息如下：

```shell
System startup

Uncompress Ok!

U-Boot 2016.11 (Nov 28 2019 - 10:19:42 +0800)hi3559av100

Relocation Offset is: 176ed000
Relocating to 5feed000, new gd at 5fe4ce00, sp at 5fe4cdf0
SPI Nor:  Check Flash Memory Controller v100 ... Found
SPI Nor ID Table Version 1.0
SPI Nor(cs 0) ID: 0xc2 0x25 0x39
Block:64KB Chip:32MB Name:"MX25U25635F/45G"
SPI Nor total size: 32MB
NAND:  0 MiB
MMC:   
In:    serial
Out:   serial
Err:   serial
Net:   gmac0
Error: gmac0 address not set.
, gmac1
Error: gmac1 address not set.

Hit any key to stop autoboot: 2 口口口 1
```

根据`Hit any key to stop autoboot`定位到源代码的两个.C文件

```shell
//bootmenu.c 

if (menu->delay > 0) {
		printf(ANSI_CURSOR_POSITION, menu->count + 5, 1);
		printf(" Hit any key to stop autoboot: %2d ", menu->delay);
	}

//autoboot.c

#ifdef CONFIG_MENUPROMPT
	printf(CONFIG_MENUPROMPT);
#else
	printf(" Hit any key to stop autoboot: %2d ", bootdelay);
#endif
```

通过修改信息发现进入执行的第二个.C文件（`autoboot.c`）,定位到`static int __abortboot(int bootdelay)`这	个函数中，发现由于烧写到`DDR`中我们无法输入字符使得无法进入`boot`，因此修改程序将其返回值`abort`设为1，直	接进入`boot`，从而可以输入相关指令进行操作，确认`U-boot`是可以正常启动的。

#### 3. flash的内容拷贝到`DDR`中测试

将Flash中的文件通过以下命令拷贝到`DDR`中并进行读取（读取结果为二进制）

**在使用`sf read`、`sf write`之前一定要用`sf probe`**

`sf read <ddr_addr> offset length`：

​	读取`Flash`的`offset`处的长度为`length`的内容到`DDR`中，`DDR`地址为`ddr_adddr`

`md <ddr_addr>  length` ：

​	读取内存`ddr_addr`处长度为`length`的内容

```shell
hisilicon # sf probe        	//探测并初始化SPI Nor Flash
hisilicon # getinfo spi			//获取SPI Nor Flash信息
Block:64KB Chip:32MB*1
ID:0xC2 0x25 0x39
Name:"MX25U25635F/45G"
hisilicon # sf read 0x82000000 0x0 0x20  //从Flash的偏移0x0处读取长度为0x100的数据写入到内存												  //(DDR)中
device 0 offset 0x0, size 0x100

SF: 32 bytes @ 0x0 Read: OK
hisilicon # md 0x82000000 0x20  		  //打印从0x82000000处开始，长度为256字节的内存数据

82000000: 14000a1c deadbeef deadbeef deadbeef    ................
82000010: deadbeef deadbeef deadbeef deadbeef    ................
82000020: deadbeef deadbeef deadbeef deadbeef    ................
82000030: deadbeef deadbeef deadbeef deadbeef    ................
82000040: 12010034 00000001 00000000 0000b805    4...............
82000050: 12010034 00000000 00000000 0000b805    4...............
82000060: 12010110 00000001 00000000 00008805    ................
82000070: 120100e4 00000000 00000000 000000fd    ................
```

然后通过`UltraEdit`去读取编译好的`U-boot.bin`文件的二进制格式，对比两者发现并没有错位或者1位翻转的现象，说明将`U-boot`烧写进`Flash`这个过程并没有问题。

`HiTool`工具首先断开与烧写使用串口的连接（左上角断开连接），然后代开自带的终端工具，连接串口，进入`boot`。

在终端中然后通过一些命令将`Flash`中的内容拷贝到`DDR`中，并通过`go`命令进行执行。

```shell
hisilicon # printenv                  //查看环境变量
arch=arm
baudrate=115200
board=hi3559av100
board_name=hi3559av100
bootargs=mem=256M console=ttyAMA0,115200n8
bootcmd=bootm 0x42000000
bootdelay=2
cpu=armv8
ethact=gmac0
soc=hi3559av100
stderr=serial
stdin=serial
stdout=serial
vendor=hisilicon
verify=n

Environment size: 283/262140 bytes
hisilicon # sf probe
hisilicon # sf read 0x42000000 0x0 0x60000
device 0 offset 0x0, size 0x60000

SF: 393216 bytes @ 0x0 Read: OK
hisilicon # bootm 0x42000000  				//启动内核的命令
Wrong Image Format for bootm command
ERROR: can't get kernel image!
hisilicon # go 0x42000000					//执行相应地址的程序
## Starting application at 0x42000000 ...

System startup

Uncompress Ok!

U-Boot 2016.11 (Dec 04 2019 - 15:51:10 +0800)hi3559av100

Relocation Offset is: 176ed000
Relocating to 5feed000, new gd at 5fe4ce00, sp at 5fe4cdf0
SPI Nor:  Check Flash Memory Controller v100 ... Found
SPI Nor ID Table Version 1.0
SPI Nor(cs 0) ID: 0xc2 0x25 0x39
Block:64KB Chip:32MB Name:"MX25U25635F/45G"
SPI Nor total size: 32MB
NAND:  0 MiB
MMC:   
*** Warning - bad CRC, using default environment

In:    serial
Out:   serial
Err:   serial
Net:   gmac0
Error: gmac0 address not set.
, gmac1
Error: gmac1 address not set.

Hit any key to stop autoboot:  0 
Wrong Image Format for bootm command
ERROR: can't get kernel image!
hisilicon # 
```

#### 4. 问题解决

发现成功地打印出相关启动信息，说明烧写进入`Flash`的`U-boot`能够正确启动，将问题定位到海思芯片上的`bootrom`（片上内存，上电或者复位后执行的第一个代码）不能正确引导`Uboot`，所以不能启动。结合文档上说明的`3byte/4byte`，阅读`MX25U25635F`的文档，发现默认设置为`3byte`模式，目标板上接线模式为4线，两者存在冲突，将目标班上的接线模式改为3线之后能够正确启动U-boot。



### 二 kernel烧写

`tftp`烧写指令

```shell
mw.b 0x41000000 0xff 0x900000 					/* 对内存初始化*/ 
tftp 0x41000000 uImage_hi3559av100_multi-core	/*uImage下载到内存*/ 
sf probe 0 										/*探测并初始化SPI flash*/ 
sf erase 0x100000 0x900000 						/*擦除 9M大小*/ 
sf write 0x41000000 0x100000 0x400000 	/*从内存写入SPI NOR Flash，0x1000000偏移地址*/ 
```



#### 1. 烧写问题

用串口进行烧写完整的`uboot`，`kernel`，`rootfs`的时候，烧写成功后启动`U-boot`后加载`kernel`的时候出现以下问题：

>```shell
>Wrong Image Format for bootm command                                            
>ERROR: can't get kernel image!
>```
>
>解决办法：
>
>>1. 首先检查拨码开关是否从`flash`启动
>>
>>2. 查看文档《启动介质烧写指南》，检查是否设置启动参数
>>
>>3. 查看用`HiTool`烧写时打印的命令发现`SPI Nor Flash`和`SPI Nand Flash`的烧写指令不同，同时启动参数的设置也不同

因网口暂时还存在问题，用`HiTool`通过串口烧写kernel。开始将kernel和文件系统一同通过`HiTool`烧写进`flash`，出现以下问题：

```shell
Load fip from 0x0000000041000000 ...
Firmware Image Package ToC:
---------------------------
- EL3 Runtime Firmware BL3-1: offset=0xD8, size=0x7090
- Non-Trusted Firmware BL3-3: offset=0x7168, size=0x82E2B6
- EL3 Runtime Firmware BL3-1: offset=0x83541E, size=0x7090
- Non-Trusted Firmware BL3-3: offset=0x83C4AE, size=0x82E2B6
---------------------------
Create Entry Point info ...
Get - EL3 Runtime Firmware BL3-1 
Get - Non-Trusted Firmware BL3-3 
kernel_size[0x82e2b6] fdt_size[0x8276] fdt_addr[0x00000000448a6000]
Invalid FDT at 0x0000000046000000, hdr at 0x000000004407ffc0
exit not allowed from main input shell.
```

所以选择分开烧写，先烧写kernel。烧写完成之后设置相应的环境变量。

#### 2. U-boot内核下相关的命令解释如下

```shell
`bootargs`:设置要传递给内核的信息，主要用来告诉内核分区信息和根文件系统所在的分区
setenv bootargs 'mem=128M console=ttyAMA0,115200 root=/dev/mtdblock2 rootfstype=jffs2 rw mtdparts=hi_sfc:1M(boot),9M(kernel),16M(rootfs)' 
参数介绍：
- mem:指定内存的大小
- console：指定终端串口以及串口波特率
- root：指定根文件系统所在分区，以及读写权限
- rootfstype：指定根文件系统的文件格式，SPI Nor 需选择jffs2，SPI Nand 选择yaffs2
- mtdparts：设定flash的设备号，这是在U-boot中进行设定的，SPI Nor为hi_sfc,SPI Nand 为hinand，同时设置				U-boot、kernel、根文件系统的内存分区大小	

`bootcmd`自动启动时默认执行的一些命令
SPI Nand设置的命令：
setenv bootcmd 'nand read 0x44000000 0x100000 0x900000;bootm 0x44000000'
SPI Nor设置的命令：
setenv bootcmd 'sf probe 0;sf read 0x41000000 0x100000 0x900000;bootm 0x41000000'
```

#### 3. 调试过程记录

在最初烧写的时候打印出`Invalid FDT at 0x0000000046000000, hdr at 0x000000004407ffc0`后程序终止，在kernel的源代码中去查找：

```shell
在load_fip.c文件中
fdt = (char *)FDT_LOAD_ADDR
g_fdt_addr = fdt;
ret = fdt_check_header(fdt);
if (ret) {
	printf("Invalid FDT at 0x%p, hdr at 0x%p\n", fdt, hdr);
	goto error;
}
在一个偏移地址kernel_load_addr + 0x1F80000出加载FDT。
FDT就是扁平设备数，简单理解为将部分设备信息结构存放到device tree文件中。uboot最终将其device tree编译成dtb文件，使用过程中通过解析该dtb来获取板级设备信息。uboot的dtb和kernel中的dtb是一致的。
```

通过`md`命令去`0x46000000`处读取相应信息，发现内容全为1。怀疑烧写过程中出现问题。重新烧写`kernel`，然后通过`HiTool`自带终端连接进入`boot`。首先读取`0x46000000`处内容如下：

```shell
hisilicon # sf probe        	//探测并初始化SPI Nor Flash
hisilicon # sf read 0x82000000 0x0 0x20  //从Flash的偏移0x0处读取长度为0x100的数据写入到内存												  //(DDR)中
device 0 offset 0x0, size 0x20

SF: 32 bytes @ 0x0 Read: OK
hisilicon # md 0x82000000 0x20  		  //打印从0x82000000处开始，长度为256字节的内存数据
82000000: c4a0a3a2 a5a4a7a6 f4f5f6f7 f0f1f2f3    ................               
82000010: b1b0b3b2 50b4b7b6 e4e5b9e7 e0e1e2e3    .......P........               
82000020: c19dc3c2 c5c4c7e0 94963e14 90919293    .........>......               
82000030: d1d0d3d2 d5d4d7d6 844b866a 804f8283    ........j.K...O.               
82000040: e1e0e387 b8e4e7e6 597bb6b7 b0b1b230    ..........{Y0...               
82000050: 94f0f3fa f5f4f7f6 a4a54ba7 a0a14fa3    .........K...O..               
82000060: 01000302 60040706 549f56d2 539f52d6    .......`.V.T.R.S               
82000070: 11101b12 15141716 c7454647 40414243    ........GFE.CBA@   
hisilicon # md 0x46000000 0x20                                                  
46000000: c4a0a3a2 a5a4a7a6 f4f5f6f7 f0f1f2f3    ................               
46000010: b1b0b3b2 50b4b7b6 e4e5b9e7 e0e1e2e3    .......P........               
46000020: c19dc3c2 c5c4c7e0 94963e14 90919293    .........>......               
46000030: d1d0d3d2 d5d4d7d6 844b866a 804f8283    ........j.K...O.               
46000040: e1e0e387 b8e4e7e6 597bb6b7 b0b1b230    ..........{Y0...               
46000050: 94f0f3fa f5f4f7f6 a4a54ba7 a0a14fa3    .........K...O..               
46000060: 01000302 60040706 549f56d2 539f52d6    .......`.V.T.R.S               
46000070: 11101b12 15141716 c7454647 40414243    ........GFE.CBA@   
```

发现内容有效，说明烧写是没有问题的。然后通过设置环境变量来启动`kernel`：

```shell
hisilicon # setenv bootargs 'mem=128M console=ttyAMA0,115200 mtdparts=hi_sfc:1M(boot),9M(kernel)' 
hisilicon # saveenv
hisilicon # setenv bootcmd 'sf probe 0;sf read 0x41000000 100000 900000;bootm 0x41000000'
hisilicon # saveenv
hisilicon # printenv                                                            
arch=arm                                                                        
baudrate=115200                                                                 
board=hi3559av100                                                               
board_name=hi3559av100                                                          
bootargs=mem=128M console=ttyAMA0,115200 mtdparts=hi_sfc:1M(boot),9M(kernel)
bootcmd=sf probe 0;sf read 0x41000000 0x100000 0x900000;bootm 0x41000000        
bootdelay=2                                                                     
cpu=armv8                                                                       
ethact=gmac0                                                                    
soc=hi3559av100                                                                 
stderr=serial                                                                   
stdin=serial                                                                    
stdout=serial                                                                   
vendor=hisilicon                                                                
verify=n   
hisilicon # reset
device 0 offset 0x100000, size 0x900000                                                                                                                                                    
SF: 9437184 bytes @ 0x100000 Read: OK                                                         
Load fip from 0x0000000041000000 ...                                                         
Firmware Image Package ToC:                                                                   
---------------------------                                                                   
- EL3 Runtime Firmware BL3-1: offset=0x88, size=0x7090                                       
- Non-Trusted Firmware BL3-3: offset=0x7118, size=0x82E2B6                                   
---------------------------                                                                   
Create Entry Point info ...                                                                   
Get - EL3 Runtime Firmware BL3-1                                                             
Get - Non-Trusted Firmware BL3-3                                                             kernel_size[0x82e2b6] fdt_size[0x8276] fdt_addr[0x00000000448a6000]                          hdr[0x000000004407ffc0] header_size[0x40] image_size[0x826040]                               
bl33_ep->spsr = 0x3c5 bl33_ep->pc = 0x44080000                                               
NOTICE:  BL31: v1.3(debug):multi-core                                                         
NOTICE:  BL31: Built : 10:22:46, Nov 28 2019                                                 
INFO:    ARM GICv2 driver initialized                                                         
INFO:    BL31: Initializing runtime services                                                 
INFO:    BL31: Preparing for EL3 exit to normal world                                         
INFO:    Entry point address = 0x44080000                                                     
INFO:    SPSR = 0x3c5                                                                         
Booting Linux on physical CPU 0x0                                                             
Linux version 4.9.37 (winston@winston) (gcc version 6.3.0 (HC&C V100R002C00B012_20180601) ) #1 SMP Thu Nov 28 10:22:40 CST 2019   
```

此时`U-boot`和`kernel`都正常启动，接下来烧写根文件系统。

### 三 烧写根文件系统

利用`HiTool`工具烧写文件系统烧写成功后，设置环境变量，添加根文件系统的相关信息。

`tftp`烧写指令：

```shell
mw.b 0x41000000 0xff 0x1000000 					/* 对内存初始化*/ 
tftp 0x41000000 rootfs_hi3559av100_64k.jffs2 	/*文件系统下载到内存*/ 
sf probe 0 										/*探测并初始化SPI flash*/ 
sf erase 0xa00000 0x1000000 						/*擦除 16M大小*/ 
sf write 0x41000000 0xa00000 0x1000000 		/*从内存写入SPI NOR Flash，0xa000000偏移地址*/ 
```



`reset`出现以下问题：

```shell
UDF-fs: warning (device mtdblock2): udf_fill_super: No partition found (2)
yaffs: dev is 32505858 name is "mtdblock2" rw
yaffs: passed flags ""
yaffs: dev is 32505858 name is "mtdblock2" rw
yaffs: passed flags ""
------------[ cut here ]------------
WARNING: CPU: 3 PID: 1 at mm/page_alloc.c:3532 __alloc_pages_nodemask+0x2c0/0xab0
Modules linked in:

CPU: 3 PID: 1 Comm: swapper/0 Not tainted 4.9.37 #1
Hardware name: Hisilicon HI3559AV100 DEMO Board (DT)
task: ffffffc005c40000 task.stack: ffffffc005c2c000
PC is at __alloc_pages_nodemask+0x2c0/0xab0
LR is at __alloc_pages_nodemask+0xbc/0xab0
pc : [<ffffff80081227e0>] lr : [<ffffff80081225dc>] pstate: 20000005
sp : ffffffc005c2f630
x29: ffffffc005c2f630 x28: ffffffc0054de1e0 
x27: ffffffc0054df9e0 x26: ffffff800886fbb0 
x25: ffffff8008856000 x24: 0000000000000001 
x23: 0000000002404040 x22: 0000000000000000 
x21: 0000000002404040 x20: ffffff8008857000 
x19: 0000000000000014 x18: ffffffbf00130000 
x17: 0000000000008270 x16: 0000000000001800 
x15: 0000000000000000 x14: 00000000000000dc 
x13: 0000000000000000 x12: 0000000000000007 
x11: ffffffbf0013c020 x10: ffffffbf0013c000 
x9 : 0000000000000000 x8 : 0000000000000000 
x7 : ffffff80088a3180 x6 : 0000000000000000 
x5 : fffffffffff011e5 x4 : 0000000000000000 
x3 : 0000000000000000 x2 : 0000000000000001 
x1 : ffffff800886a0da x0 : 0000000000000000 

---[ end trace 8b68623e172cbdf9 ]---
Call trace:
Exception stack(0xffffffc005c2f450 to 0xffffffc005c2f580)
f440:                                   0000000000000014 0000007fffffffff
f460: ffffffc005c2f630 ffffff80081227e0 0000000020000005 000000000000003d
f480: ffffff80088a4500 0000000000000000 ffffff80088a4500 0000000100000000
f4a0: 0000000000000000 ffffff80081225dc 0000000000000000 ffffff8008857000
f4c0: 0000000002601250 0000000000000000 0000000002601250 0000000000000001
f4e0: ffffffc005c2f550 ffffff800815a064 0000000000000000 0000000000210d00
f500: 0000000000000000 ffffff800886a0da 0000000000000001 0000000000000000
f520: 0000000000000000 fffffffffff011e5 0000000000000000 ffffff80088a3180
f540: 0000000000000000 0000000000000000 ffffffbf0013c000 ffffffbf0013c020
f560: 0000000000000007 0000000000000000 00000000000000dc 0000000000000000
[<ffffff80081227e0>] __alloc_pages_nodemask+0x2c0/0xab0
[<ffffff8008139358>] kmalloc_order+0x20/0x40
[<ffffff800815a1cc>] __kmalloc+0xe4/0x138
[<ffffff80082d3bd8>] yaffs_get_temp_buffer+0x78/0xb0
[<ffffff80082dc51c>] yaffs_tags_marshall_read+0x1d4/0x220
[<ffffff80082da62c>] yaffs2_checkpt_find_block+0x8c/0x190
[<ffffff80082db0b0>] yaffs2_checkpt_rd+0x1e8/0x220
[<ffffff80082de630>] yaffs2_rd_checkpt_validity_marker+0x20/0xa0
[<ffffff80082df278>] yaffs2_checkpt_restore+0x60/0x698
[<ffffff80082d9f38>] yaffs_guts_initialise+0x468/0x7e0
[<ffffff80082d2f74>] yaffs_internal_read_super.isra.13+0x3f4/0x798
[<ffffff80082d3330>] yaffs2_internal_read_super_mtd+0x18/0x30
[<ffffff8008166ae8>] mount_bdev+0x190/0x1b8
[<ffffff80082cfb5c>] yaffs2_mount+0x14/0x20
[<ffffff80081676e4>] mount_fs+0x1c/0xa8
[<ffffff8008183ad8>] vfs_kern_mount+0x50/0x118
[<ffffff8008186224>] do_mount+0x16c/0xba0
[<ffffff8008187004>] SyS_mount+0x8c/0xf8
[<ffffff8008800f3c>] mount_block_root+0x104/0x2b8
[<ffffff8008801284>] mount_root+0x74/0x84
[<ffffff80088013f8>] prepare_namespace+0x164/0x1a0
[<ffffff8008800c74>] kernel_init_freeable+0x1c0/0x1e0
[<ffffff80086307c8>] kernel_init+0x10/0x100
[<ffffff8008082ee0>] ret_from_fork+0x10/0x30
------------[ cut here ]------------
kernel BUG at fs/yaffs2/yaffs_getblockinfo.h:31!
Internal error: Oops - BUG: 0 [#1] SMP
Modules linked in:
CPU: 3 PID: 1 Comm: swapper/0 Tainted: G        W       4.9.37 #1
Hardware name: Hisilicon HI3559AV100 DEMO Board (DT)
task: ffffffc005c40000 task.stack: ffffffc005c2c000
PC is at yaffs_rd_chunk_tags_nand+0xac/0xc8
LR is at yaffs_rd_chunk_tags_nand+0xc0/0xc8
pc : [<ffffff80082db7d4>] lr : [<ffffff80082db7e8>] pstate: 60000005
sp : ffffffc005c2f820
x29: ffffffc005c2f820 x28: 0000000000010000 
x27: 0000000000000000 x26: ffffffc004e00000 
x25: 0000000001010000 x24: 0000000000010000 
x23: 0000000000000100 x22: 0000000000000000 
x21: ffffffc005c2f938 x20: 0000000001010000 
x19: ffffffc0054de000 x18: ffffff80088b2578 
x17: 0000000000008270 x16: 0000000000001800 
x15: 0000000000008000 x14: 000000000000011e 
x13: 0000000000000000 x12: 0000000000000007 
x11: 0000000000000006 x10: 000000000000011e 
x9 : 0000000000000001 x8 : ffffffc007b7d92c 
x7 : 0000000000000000 x6 : ffffffc007b7d8e4 
x5 : ffffffc007b78000 x4 : 0000000000000000 
x3 : 0000000000000000 x2 : 000000000000065e 
x1 : ffffff8008866328 x0 : 0000000000000038 

Process swapper/0 (pid: 1, stack limit = 0xffffffc005c2c020)
Stack: (0xffffffc005c2f820 to 0xffffffc005c30000)
f820: ffffffc005c2f8a0 ffffff80082e0ec0 00000000000c0000 0000000000000000
f840: ffffffc004e00000 ffffffc0054de000 ffffffc005c2f880 ffffff80082d3bd8
f860: ffffffc0054de000 ffffffc0055627f8 ffffffc004e00000 ffffffc0054de000
f880: ffffffc005c2f8a0 ffffff80082e0e88 ffffffc005562000 00000000000000ff
f8a0: ffffffc005c2f980 ffffff80082dfc78 ffffffc005562000 ffffffc0055627f8
f8c0: 0000000000000100 00000000efffeeff ffffffc005562800 00000000000007f8
f8e0: 0000000000000000 00000000000000fe ffffffc0054df9e0 ffffffc0054de000
f900: ffffffc005c2f980 ffffff80082dfbfc ffffffc0055627f8 ffffffe100000100
f920: ffffff800875c458 0000000000000010 ffffffc005562800 0000000000000101
f940: 0000000000000000 00000000000000ff ffffffc0054df9e0 ffffffc0054de000
f960: ffffffc005c2f980 ffffff80082dfc28 0000000000000100 0000000000000100
f980: ffffffc005c2fa90 ffffff80082da248 0000000000000001 ffffffc00542e568
f9a0: ffffffc0054de000 0000000002400040 0000000000000001 ffffff800886f000
f9c0: 0000000000000000 ffffff800886fbb0 ffffffc0054df9e0 ffffffc0054de1e0
f9e0: ffffff800875cba8 ffffff80082d367c ffffffc0055e4500 00000000055e45b8
fa00: ffffffc0054de000 0000000002400040 0000000000000000 ffffff80082d47a0
fa20: ffffffc005562800 ffffffc005562000 0542e56800000002 ffffffc005c2fa38
fa40: ffffffc005c2fa38 0000000000000028 ffffffc005c2fa70 ffffff80082d4c4c
fa60: ffffffc0054de000 ffffffc00542e568 ffffffc005c2fa90 ffffff80082da238
fa80: 0000000000000001 ffffffc00542e568 ffffffc005c2faf0 ffffff80082d2f74
faa0: ffffffc005561800 ffffffc0054de000 ffffff800886f000 ffffff8008689000
fac0: ffffff80088cd488 ffffffc005064e00 ffffffc0054de0e8 ffffff800886fbb0
fae0: 0000000000000001 0000000000000000 ffffffc005c2fbb0 ffffff80082d3330
fb00: ffffffc0059080b8 ffffffc005561800 ffffffc005908000 0000000000000083
fb20: 0000000000008000 ffffff80082d3318 0000000000000000 ffffff8008730300
fb40: ffffff80088249d8 0000000000008000 ffffffc005c2fbc0 6b636f6c6264746d
fb60: ffffffc005c20032 00000000ffffffd8 ffffffc005c2fbc0 ffffffc005c2fbc0
fb80: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fba0: 0000000000000000 ffffff8000000000 ffffffc005c2fbc0 ffffff8008166ae8
fbc0: ffffffc005c2fc10 ffffff80082cfb5c ffffffc0056de480 ffffff800886fde8
fbe0: ffffff800886fde8 0000000000008000 0000000000000000 0000000000000001
fc00: 0000000000008000 ffffff800886fde8 ffffffc005c2fc20 ffffff80081676e4
fc20: ffffffc005c2fc50 ffffff8008183ad8 ffffffc0056de480 ffffff800886fde8
fc40: ffffffc005064b80 ffffffc005064b00 ffffffc005c2fc90 ffffff8008186224
fc60: ffffff800886fde8 0000000000000020 0000000000000000 ffffffc005064b80
fc80: ffffffc005064b00 ffffff800818615c ffffffc005c2fd20 ffffff8008187004
fca0: ffffffc005064b00 0000000000000000 ffffffc005064b80 0000000000000000
fcc0: ffffff8008730300 0000000000008000 ffffff8008730440 ffffff8008730300
fce0: ffffff80088249d8 ffffff8008753e68 ffffffc005c28020 ffffffc005809540
fd00: ffffffc005064b00 ffffff8008730440 ffffffc005064b80 0000000000000000
fd20: ffffffc005c2fd60 ffffff8008800f3c ffffffc0056dd044 ffffffc0056dd000
fd40: ffffffbf0015b740 ffffffffffffffea ffffff8008824000 0000000000008000
fd60: ffffffc005c2fde0 ffffff8008801284 0000000000001f00 ffffff8008730440
fd80: ffffff8008730000 0000000000000008 ffffff80088a9000 ffffff8008800458
fda0: ffffff80087f2060 ffffff8008824998 ffffff800882e3d0 0000000000000000
fdc0: ffffffc005c28020 ffffffc0058093c0 ffffffc005c2fde0 ffffff8008801260
fde0: ffffffc005c2fe10 ffffff80088013f8 ffffff8008824000 ffffff80088a9048
fe00: ffffff80088249f5 ffffff8008824998 ffffffc005c2fe40 ffffff8008800c74
fe20: 00000000000000a1 ffffff80088a9000 ffffff8008824998 0000000000000008
fe40: ffffffc005c2fea0 ffffff80086307c8 ffffff80086307b8 0000000000000000
fe60: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fe80: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fea0: 0000000000000000 ffffff8008082ee0 ffffff80086307b8 0000000000000000
fec0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
fee0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
ff00: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
ff20: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
ff40: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
ff60: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
ff80: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
ffa0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
ffc0: 0000000000000000 0000000000000005 0000000000000000 0000000000000000
ffe0: 0000000000000000 0000000000000000 868584838281808f 878485828380818e
Call trace:
Exception stack(0xffffffc005c2f640 to 0xffffffc005c2f770)
f640: ffffffc0054de000 0000007fffffffff ffffffc005c2f820 ffffff80082db7d4
f660: 0000000060000005 000000000000003d ffffff80088b219a 0000000000000038
f680: ffffffc005c2f6a0 ffffff80080db534 ffffff80087382f0 0000000008866310
f6a0: ffffffc005c2f740 ffffff80080db818 ffffffc0054de000 0000000001010000
f6c0: ffffffc005c2f938 0000000000000000 0000000000000100 0000000000010000
f6e0: 0000000001010000 ffffffc004e00000 0000000000000038 ffffff8008866328
f700: 000000000000065e 0000000000000000 0000000000000000 ffffffc007b78000
f720: ffffffc007b7d8e4 0000000000000000 ffffffc007b7d92c 0000000000000001
f740: 000000000000011e 0000000000000006 0000000000000007 0000000000000000
f760: 000000000000011e 0000000000008000
[<ffffff80082db7d4>] yaffs_rd_chunk_tags_nand+0xac/0xc8
[<ffffff80082e0ec0>] yaffs_summary_read+0xa8/0x290
[<ffffff80082dfc78>] yaffs2_scan_backwards+0x240/0xef8
[<ffffff80082da248>] yaffs_guts_initialise+0x778/0x7e0
[<ffffff80082d2f74>] yaffs_internal_read_super.isra.13+0x3f4/0x798
[<ffffff80082d3330>] yaffs2_internal_read_super_mtd+0x18/0x30
[<ffffff8008166ae8>] mount_bdev+0x190/0x1b8
[<ffffff80082cfb5c>] yaffs2_mount+0x14/0x20
[<ffffff80081676e4>] mount_fs+0x1c/0xa8
[<ffffff8008183ad8>] vfs_kern_mount+0x50/0x118
[<ffffff8008186224>] do_mount+0x16c/0xba0
[<ffffff8008187004>] SyS_mount+0x8c/0xf8
[<ffffff8008800f3c>] mount_block_root+0x104/0x2b8
[<ffffff8008801284>] mount_root+0x74/0x84
[<ffffff80088013f8>] prepare_namespace+0x164/0x1a0
[<ffffff8008800c74>] kernel_init_freeable+0x1c0/0x1e0
[<ffffff80086307c8>] kernel_init+0x10/0x100
[<ffffff8008082ee0>] ret_from_fork+0x10/0x30
Code: d65f03c0 90002ca0 b94bb400 37f00040 (d4210000) 
---[ end trace 8b68623e172cbdfa ]---
Kernel panic - not syncing: Fatal exception
SMP: stopping secondary CPUs
Kernel Offset: disabled
Memory Limit: 64 MB
---[ end Kernel panic - not syncing: Fatal exception
定位到
`yaffs: dev is 32505858 name is "mtdblock2" rw
`yaffs: passed flags ""
`yaffs: dev is 32505858 name is "mtdblock2" rw
`yaffs: passed flags ""
```

1. 推测是不是不支持`jffs2`这种文件格式，在`Hi3559AV100_SDK_V2.0.2.0/osdrv/opensource/kernel/linux-4.9.y_multi-core`目录下通过命令`make menuconfig`进入进入配置界面，选择`file systems `选项查看是否支持`jffs2`文件格式。发现时支持的。

2. 推测启动参数设置有关文件系统的参数配置错误（有没有设置？设置是否正确？输入是否有误？）

   重新配置：

   ```shell
   //设置bootrags
   setenv bootargs 'mem=128M console=ttyAMA0,115200 root=/dev/mtdblock2 rootfstype=jffs2 rw mtdparts=hi_sfc:1M(boot),9M(kernel),16M(rootfs)' 
saveenv 
   
   //设置bootcmd
      setenv bootcmd 'sf probe 0;sf read 0x41000000 100000 900000;bootm 0x41000000'
      saveenv
   ```

  解决以上问题，成功进入文件系统

>**注意**
>
>在设置环境变量的时候将`mem`设为`64M`最初出现以下问题：虽然成功进入了文件系统，但是查看打印信息，发现是内存不够导致挂载设备时失败。
>
>```shell
>[RCS]: /etc/init.d/S00devs
>[RCS]: /etc/init.d/S01udev
>[RCS]: /etc/init.d/S80network
>Auto login as root ...
>login[1373]: root login on 'ttyS000'
>Welcome to HiLinux.
>udevd invoked oom-killer: gfp_mask=0x26040d0(GFP_TEMPORARY|__GFP_COMP|__GFP_NOTRACK), nodemask=0, order=0, oom_score_adj=-1000                           
>CPU: 2 PID: 940 Comm: udevd Not tainted 4.9.37 #1
>Hardware name: Hisilicon HI3559AV100 DEMO Board (DT)
>Call trace:
>[<ffffff8008087d60>] dump_backtrace+0x0/0x198
>[<ffffff8008088004>] show_stack+0x14/0x20
>[<ffffff8008324d9c>] dump_stack+0x94/0xb8
>[<ffffff800815fcd4>] dump_header.isra.5+0x5c/0x170
>[<ffffff800811e344>] oom_kill_process+0x29c/0x4b8
>[<ffffff800811e878>] out_of_memory+0xd0/0x3d8
>[<ffffff8008122fb8>] __alloc_pages_nodemask+0xa98/0xab0
>[<ffffff80081582a0>] new_slab+0x2d8/0x3f8
>[<ffffff800815a064>] ___slab_alloc.constprop.27+0x274/0x2f8
>[<ffffff800815a428>] kmem_cache_alloc+0xb0/0xe8
>[<ffffff800817ddfc>] alloc_inode+0x5c/0xa8
>[<ffffff800817f108>] iget_locked+0x108/0x1f0
>[<ffffff80081d62d0>] kernfs_get_inode+0x18/0x120
>[<ffffff80081d7160>] kernfs_iop_lookup+0x70/0xe0
>[<ffffff800816da84>] lookup_slow+0x8c/0x150
>[<ffffff8008170844>] walk_component+0x18c/0x2c0
>[<ffffff8008170f5c>] path_lookupat+0x74/0x128
>[<ffffff8008172a18>] filename_lookup+0x78/0x118
>[<ffffff8008172b88>] user_path_at_empty+0x48/0x58
>[<ffffff8008168aac>] SyS_readlinkat+0x4c/0x118
>[<ffffff8008082f40>] el0_svc_naked+0x34/0x38
>Mem-Info:
>active_anon:1580 inactive_anon:0 isolated_anon:0
>active_file:13 inactive_file:19 isolated_file:0
>unevictable:0 dirty:0 writeback:0 unstable:0
>slab_reclaimable:675 slab_unreclaimable:2856
>mapped:45 shmem:1 pagetables:221 bounce:0
>free:1410 free_pcp:0 free_cma:228
>Node 0 active_anon:6320kB inactive_anon:0kB active_file:52kB inactive_file:76kB unevictable:0kB isolated(anon):0kB isolated(file):0kB mapped:180kB dirtyo
>DMA free:5640kB min:8192kB low:10240kB high:12288kB active_anon:6320kB inactive_anon:0kB active_file:52kB inactive_file:76kB unevictable:0kB writependinB
>lowmem_reserve[]: 0 0 0                                                                                                                                  
>DMA: 75*4kB (UMEC) 39*8kB (UMC) 48*16kB (UMEC) 26*32kB (UMEC) 4*64kB (UMEC) 1*128kB (U) 2*256kB (EC) 1*512kB (C) 2*1024kB (UE) 0*2048kB 0*4096kB = 5668kB
>38 total pagecache pages
>16384 pages RAM
>0 pages HighMem/MovableOnly
>6864 pages reserved
>1024 pages cma reserved
>[ pid ]   uid  tgid total_vm      rss nr_ptes nr_pmds swapents oom_score_adj name
>[  901]     0   901      505       93       4       3        0         -1000 udevd
>[  934]     0   934      473       63       5       3        0         -1000 udevd
>[  940]     0   940      473       62       5       3        0         -1000 udevd
>[  944]     0   944      473       66       5       3        0         -1000 udevd
>[  947]     0   947      473       65       5       3        0         -1000 udevd
>[  950]     0   950      473       66       5       3        0         -1000 udevd
>[  953]     0   953      473       66       5       3        0         -1000 udevd
>[  957]     0   957      473       66       5       3        0         -1000 udevd
>[  960]     0   960      473       67       5       3        0         -1000 udevd
>[  963]     0   963      473       67       5       3        0         -1000 udevd
>[  993]     0   993      473       80       5       3        0         -1000 udevd
>[  996]     0   996      473       80       5       3        0         -1000 udevd
>[  998]     0   998      473       81       5       3        0         -1000 udevd
>[ 1001]     0  1001      473       83       5       3        0         -1000 udevd
>[ 1010]     0  1010      473       84       5       3        0         -1000 udevd
>[ 1016]     0  1016      473       85       5       3        0         -1000 udevd
>[ 1030]     0  1030      505       88       5       3        0         -1000 udevd
>[ 1042]     0  1042      505       89       5       3        0         -1000 udevd
>[ 1053]     0  1053      505       90       5       3        0         -1000 udevd
>[ 1065]     0  1065      505       91       5       3        0         -1000 udevd
>[ 1075]     0  1075      505       92       5       3        0         -1000 udevd
>[ 1086]     0  1086      505       93       5       3        0         -1000 udevd
>[ 1094]     0  1094      505       67       5       3        0         -1000 udevd
>[ 1350]     0  1350      505       82       4       3        0         -1000 udevd
>[ 1351]     0  1351      505       85       4       3        0         -1000 udevd
>[ 1352]     0  1352      505       82       4       3        0         -1000 udevd
>[ 1353]     0  1353      505       92       4       3        0         -1000 udevd
>[ 1354]     0  1354      505       93       4       3        0         -1000 udevd
>[ 1355]     0  1355      505       82       4       3        0         -1000 udevd
>[ 1356]     0  1356      505       82       4       3        0         -1000 udevd
>[ 1357]     0  1357      505       82       4       3        0         -1000 udevd
>[ 1358]     0  1358      505       85       4       3        0         -1000 udevd
>[ 1359]     0  1359      505       85       4       3        0         -1000 udevd
>[ 1360]     0  1360      505       82       4       3        0         -1000 udevd
>[ 1361]     0  1361      505       95       4       3        0         -1000 udevd
>[ 1362]     0  1362      505       82       4       3        0         -1000 udevd
>[ 1363]     0  1363      505       85       4       3        0         -1000 udevd
>[ 1364]     0  1364      505       85       4       3        0         -1000 udevd   
>[ 1365]     0  1365      505       82       4       3        0         -1000 udevd   
>[ 1366]     0  1366      505       82       4       3        0         -1000 udevd   
>[ 1367]     0  1367      505       85       4       3        0         -1000 udevd    
>[ 1368]     0  1368      505       89       4       3        0         -1000 udevd   
>[ 1369]     0  1369      505       82       4       3        0         -1000 udevd   
>[ 1370]     0  1370      505       85       5       3        0         -1000 udevd   
>[ 1371]     0  1371      505       83       5       3        0         -1000 udevd   
>[ 1372]     0  1372      505       86       5       3        0         -1000 udevd   
>[ 1373]     0  1373      831       11       5       3        0             0 sh       
>Out of memory: Kill process 1373 (sh) score 1 or sacrifice child                     
>Killed process 1373 (sh) total-vm:3324kB, anon-rss:44kB, file-rss:0kB, shmem-rss:0kB
>Auto login as root ...                                                               
>login[1374]: root login on 'ttyS000'                                                 
>Welcome to HiLinux.                                                                   
>None of nfsroot found in cmdline. 
>```
>
>利用`free`和`top`命令查看剩余内存和进程信息
>
>```shell
>～ # top
>Mem: 21768K used, 81748K free, 4K shrd, 0K buff, 1336K cached
>Mem: 21768K used, 81748K free, 4K shrd, 0K buff, 1336K cached
>CPU:  0.0% usr  0.0% sys  0.0% nic  100% idle  0.0% io  0.0% irq  0.0% sirq
>Load average: 0.00 0.00 0.00 1/93 1417
>PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
>1417  1407 root     R     3324  3.2   0  0.0 top
>1     0 root     S     3324  3.2   0  0.0 init
>1407     1 root     S     3324  3.2   1  0.0 -sh
>Mem: 21796K used, 81720K free, 4K shrd, 0K buff, 1340K cached
>CPU:  0.0% usr  0.0% sys  0.0% nic  100% idle  0.0% io  0.0% irq  0.0% sirq
>Load average: 0.00 0.00 0.00 1/93 1419
>PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
>1     0 root     S     3324  3.2   0  0.0 init
>1419  1407 root     R     3324  3.2   0  0.0 top
>1407     1 root     S     3324  3.2   1  0.0 -sh
>1413   901 root     S <   2412  2.3   2  0.0 udevd --daemon
>1414   901 root     S <   2412  2.3   0  0.0 udevd --daemon
>901     1 root      S <   2160  2.0   3  0.0 udevd --daemon
>887     2 root     SWN      0  0.0   2  0.0 [jffs2_gcd_mtd2]
>509     2 root     SW       0  0.0   2  0.0 [kworker/2:1]
>17      2 root     SW       0  0.0   1  0.0 [kworker/1:0]
>29      2 root     SW       0  0.0   3  0.0 [kworker/3:0]
>2       0 root     SW       0  0.0   1  0.0 [kthreadd]
>3       2 root     SW       0  0.0   0  0.0 [ksoftirqd/0]
>4       2 root     SW       0  0.0   0  0.0 [kworker/0:0]
>5       2 root     SW<      0  0.0   0  0.0 [kworker/0:0H]
>6       2 root     SW       0  0.0   2  0.0 [kworker/u8:0]
>7       2 root     SW       0  0.0   0  0.0 [rcu_sched]
>8       2 root     SW       0  0.0   0  0.0 [rcu_bh]
>9       2 root     SW       0  0.0   0  0.0 [migration/0]
>10      2 root     SW<      0  0.0   0  0.0 [lru-add-drain]
>11      2 root     SW       0  0.0   0  0.0 [watchdog/0] 
>~ # free                                                                                                                                      
>        total       used       free     shared    buffers     cached
>mem:        103516      21768      81748          4          0       1340
>-/+ buffers/cache:      20428      83088
>Swap:            0          0          0  
>```
>
>并没有发现内存不够，可能是在启动的过程中会开启其余的进程使得内存不够，将环境变量中的`mem`设置为`128M`之后能成功启动并没有打印错误信息。

### 四 网口测试

利用网口进行烧写，`tftp`指令输入无反应，同时板子上网口的指示灯没亮。

**解决办法**

海思以太网`phy`时钟源有两种，一种由海思内部`pll`输出`25MHz`，一种由板载晶振提供时钟。现在测试板1发现海思输出给`phy`的`25MHz`时钟没有给到`phy`芯片，怀疑是排阻虚焊，现将海思`phy`时钟源更换为板载晶振，以太网测试没问题。可以用`nfs`挂载文件目录，也可以用`tftp`烧写

### 五  SD卡和`eMMC`测试

### 1 操作准备

- U-boot 和 Linux内核使用SDK发布的U-boot和kernel
- 文件系统，SPI Nand Flash 用yaffs2格式，SPI Nor Flash用jffs2格式，eMMC 用ext4格式

#### 2 操作过程

- 步骤一 ：启动单板，加载文件系统
- 步骤二： 加载内核，默认SD/eMMC相关模块已经编入内核。
- 步骤三： 插入SD/eMMC卡，就可以进行相关操作，通过SDIO接口实现读写。

总体流程如下图所示：

```flow
st=>start: 插入SD卡
cond1=>condition: 是否已分区？
op1=>operation: 分区
cond2=>condition: 是否已格式化?
op2=>operation: 格式化
op3=>operation: 挂载目录
e=>end: 读写文件

st->cond1
cond1(yes)->cond2
cond2(yes)->op3->e
cond2(no)->op2->op3->e
cond1(no)->op1->cond2
cond2(yes)->op3->e
cond2(no)->op2->op3->e
​```
```

- 步骤四：查看分区信息

  若没有显示出p1，表示还没有分区，见如下步骤进行分区

  若显示出p1，则SD/eMMC已经检测到，并已经分区

  >
  >
  >